-- Schema for embedded H2 database: users table used by AppUser entity
-- Spring Data JDBC quotes identifiers ("users"."ID"...), so we create uppercase column names.
CREATE TABLE IF NOT EXISTS users (
  ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USERNAME VARCHAR(100) NOT NULL UNIQUE,
  PASSWORD VARCHAR(255) NOT NULL,
  ROLES VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS members (
  ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID BIGINT NOT NULL UNIQUE,
  FIRST_NAME VARCHAR(80) NOT NULL,
  LAST_NAME VARCHAR(80) NOT NULL,
  PHONE VARCHAR(30),
  BIRTH_DATE DATE,
  ACTIVE BOOLEAN DEFAULT TRUE,
  CONSTRAINT FK_MEMBERS_USER FOREIGN KEY (USER_ID) REFERENCES users(ID)
);

CREATE TABLE IF NOT EXISTS subscription_plans (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  duration_days INT NOT NULL,
  price_cents INT NOT NULL,
  includes_classes BOOLEAN DEFAULT FALSE,
  description VARCHAR(1000),
  active BOOLEAN DEFAULT TRUE
);

-- Subscriptions table: stores member subscriptions to plans, with lifecycle and auto-renew
CREATE TABLE IF NOT EXISTS subscriptions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  member_id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  status VARCHAR(20) NOT NULL,
  auto_renew BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT FK_SUBS_MEMBER FOREIGN KEY (member_id) REFERENCES members(ID),
  CONSTRAINT FK_SUBS_PLAN FOREIGN KEY (plan_id) REFERENCES subscription_plans(id)
);

CREATE TABLE IF NOT EXISTS payments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subscription_id BIGINT,
  member_id BIGINT NOT NULL,
  amount_cents INT NOT NULL,
  method VARCHAR(50),
  status VARCHAR(50),
  payment_date TIMESTAMP,
  reference VARCHAR(255),
  CONSTRAINT FK_PAYMENTS_MEMBER FOREIGN KEY (member_id) REFERENCES members(ID),
  CONSTRAINT FK_PAYMENTS_SUBSCRIPTION FOREIGN KEY (subscription_id) REFERENCES subscriptions(id)
);

CREATE TABLE IF NOT EXISTS courses (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  description VARCHAR(2000),
  duration_minutes INT,
  capacity INT,
  active BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS course_schedules (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  course_id BIGINT NOT NULL,
  coach_id BIGINT,
  room VARCHAR(100),
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  capacity INT,
  active BOOLEAN DEFAULT TRUE,
  CONSTRAINT FK_SCHEDULES_COURSE FOREIGN KEY (course_id) REFERENCES courses(id)
);

CREATE TABLE IF NOT EXISTS bookings (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  schedule_id BIGINT NOT NULL,
  member_id BIGINT NOT NULL,
  status VARCHAR(50) NOT NULL CHECK (status IN ('CONFIRMED','CANCELLED','WAITING')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT FK_BOOKINGS_SCHEDULE FOREIGN KEY (schedule_id) REFERENCES course_schedules(id),
  CONSTRAINT FK_BOOKINGS_MEMBER FOREIGN KEY (member_id) REFERENCES members(ID)
);

CREATE TABLE IF NOT EXISTS waitlists (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  schedule_id BIGINT NOT NULL,
  member_id BIGINT NOT NULL,
  position INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT FK_WAITLIST_SCHEDULE FOREIGN KEY (schedule_id) REFERENCES course_schedules(id),
  CONSTRAINT FK_WAITLIST_MEMBER FOREIGN KEY (member_id) REFERENCES members(ID)
);
